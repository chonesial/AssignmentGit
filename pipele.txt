pipeline {
    agent any 
    
    stages {
        
        stage("SCM") {
            steps {
                git branch: 'main', url: 'https://github.com/chonesial/AssignmentGit.git'
            }
        }
   
        
        stage('build') {
            steps {
                script {
                    sh 'docker build -t chonesial/assignment_no_6:$BUILD_NUMBER .'
                }
            }
        }
        
        stage('Push Image to Docker hub') { 
            steps {
                withCredentials([usernamePassword(credentialsId: 'chonesial1.0', usernameVariable: 'DOCKERHUB_USERNAME', passwordVariable: 'DOCKERHUB_PASSWORD')]) {
                    sh 'docker login -u ${DOCKERHUB_USERNAME} -p ${DOCKERHUB_PASSWORD}'
                }
                sh 'docker push chonesial/assignment_no_6:$BUILD_NUMBER'
            }
        }
       stage('deploy') {
            steps {
                sshagent(credentials: ['ssh-creds']) {
                    
                sh '''
          ssh ubuntu@43.204.106.51 "docker ps -aq | xargs docker rm -f"       
          ssh ubuntu@43.204.106.51 "docker run -p 80:80 -d chonesial/assignment_no_6:$BUILD_NUMBER"
          
      '''
                 
                 }
                script {
                    sh 'echo test'
                }
            }
        }
    }   
}